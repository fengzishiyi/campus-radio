{% extends "base.html" %}

{% block title %}å…¬å‘Šåˆ—è¡¨ - æ ¡å›­å¹¿æ’­ç«™ç®¡ç†å¹³å°{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-3xl font-bold text-gray-800">ğŸ“¢ å…¬å‘Šåˆ—è¡¨</h1>
            {% if perms.announcements or user.profile.is_admin %}
                <a href="{% url 'announcements:create' %}" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                    â• å‘å¸ƒå…¬å‘Š
                </a>
            {% endif %}
        </div>

        <!-- Filters -->
        <form method="get" class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-medium text-gray-700 mb-1">ç±»å‹ç­›é€‰</label>
                <select name="type" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" onchange="this.form.submit()">
                    <option value="">å…¨éƒ¨ç±»å‹</option>
                    {% for value, label in type_choices %}
                        <option value="{{ value }}" {% if filter_type == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-medium text-gray-700 mb-1">éƒ¨é—¨ç­›é€‰</label>
                <select name="department" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" onchange="this.form.submit()">
                    <option value="">å…¨éƒ¨éƒ¨é—¨</option>
                    {% for value, label in department_choices %}
                        <option value="{{ value }}" {% if filter_department == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            {% if filter_type or filter_department %}
                <div class="flex items-end">
                    <a href="{% url 'announcements:list' %}" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition">
                        æ¸…é™¤ç­›é€‰
                    </a>
                </div>
            {% endif %}
        </form>
    </div>

    <!-- Announcements List -->
    <div class="space-y-4">
        {% for announcement in announcements %}
        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition {% if announcement.is_pinned %}border-l-4 border-red-500{% endif %}">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <!-- Type Badge -->
                        {% if announcement.type == 'urgent' %}
                            <span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded">{{ announcement.get_type_display }}</span>
                        {% elif announcement.type == 'activity' %}
                            <span class="px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded">{{ announcement.get_type_display }}</span>
                        {% elif announcement.type == 'schedule_change' %}
                            <span class="px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded">{{ announcement.get_type_display }}</span>
                        {% else %}
                            <span class="px-2 py-1 text-xs font-semibold bg-blue-100 text-blue-800 rounded">{{ announcement.get_type_display }}</span>
                        {% endif %}

                        <!-- Pinned Badge -->
                        {% if announcement.is_pinned %}
                            <span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded">ğŸ“Œ ç½®é¡¶</span>
                        {% endif %}

                        <!-- Unread Badge -->
                        {% if announcement.is_unread_by user %}
                            <span class="px-2 py-1 text-xs font-semibold bg-orange-100 text-orange-800 rounded">ğŸ†• æœªè¯»</span>
                        {% endif %}

                        <!-- Department Badge -->
                        <span class="px-2 py-1 text-xs font-semibold bg-gray-100 text-gray-800 rounded">
                            {{ announcement.get_target_department_display }}
                        </span>
                    </div>

                    <h2 class="text-xl font-bold text-gray-800 mb-2">
                        <a href="{% url 'announcements:detail' announcement.pk %}" class="hover:text-blue-600">
                            {{ announcement.title }}
                        </a>
                    </h2>

                    <p class="text-gray-600 mb-3 line-clamp-2">{{ announcement.content|truncatewords:30 }}</p>

                    <div class="flex items-center gap-4 text-sm text-gray-500">
                        <span>ğŸ‘¤ {{ announcement.publisher.get_full_name|default:announcement.publisher.username }}</span>
                        <span>ğŸ“… {{ announcement.publish_time|date:"Y-m-d H:i" }}</span>
                        <span>ğŸ‘ï¸ {{ announcement.read_by.count }} äººå·²è¯»</span>
                        {% if announcement.expire_time %}
                            <span>â° {{ announcement.expire_time|date:"Y-m-d H:i" }} è¿‡æœŸ</span>
                        {% endif %}
                    </div>
                </div>

                <div class="flex gap-2 ml-4">
                    {% if perms.announcements or user.profile.is_admin %}
                        <a href="{% url 'announcements:edit' announcement.pk %}" class="px-3 py-1 text-sm bg-yellow-500 text-white rounded hover:bg-yellow-600 transition">
                            ç¼–è¾‘
                        </a>
                        <a href="{% url 'announcements:delete' announcement.pk %}" class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600 transition">
                            åˆ é™¤
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="bg-white rounded-lg shadow-md p-12 text-center">
            <p class="text-gray-500 text-lg">æš‚æ— å…¬å‘Š</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
