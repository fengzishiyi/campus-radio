{% extends 'base.html' %}

{% block title %}{{ date|date:"Yå¹´mæœˆdæ—¥" }} - å½•éŸ³å®¤ - æ ¡å›­å¹¿æ’­ç«™ç®¡ç†å¹³å°{% endblock %}

{% block content %}
<div class="gh-card" style="margin-bottom: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h1 style="font-size: 24px; font-weight: 600; margin: 0;">
            ğŸ“… {{ date|date:"Yå¹´mæœˆdæ—¥ l" }}
        </h1>
        <div style="display: flex; gap: 8px;">
            <a href="/studio/" class="gh-btn">â† è¿”å›æ—¥å†</a>
            <form method="post" action="{% url 'studio:toggle_live' date|date:'Y-m-d' %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="gh-btn {% if schedule.is_live %}gh-btn-danger{% else %}gh-btn-primary{% endif %}">
                    {% if schedule.is_live %}
                        ğŸ“¡ å…³é—­ç›´æ’­
                    {% else %}
                        ğŸ“¡ å¼€å¯ç›´æ’­
                    {% endif %}
                </button>
            </form>
        </div>
    </div>
    
    {% if schedule.is_live %}
    <div class="gh-alert gh-alert-warning">
        <strong>ğŸ“¡ ç›´æ’­ä¸­</strong> æœ¬æ—¥ 16:00-18:00 è¿›è¡Œç›´æ’­
    </div>
    {% endif %}
</div>

<!-- Timeline Visualization -->
<div class="gh-card" style="margin-bottom: 24px;">
    <h3 class="gh-card-header">ğŸ™ï¸ ä»Šæ—¥æ—¶é—´è½´ (8:00-22:00)</h3>
    
    <div class="gh-timeline-scale">
        {% for hour in timeline_hours %}
            <span class="gh-timeline-hour">{{ hour }}:00</span>
        {% endfor %}
    </div>
    
    <div class="gh-timeline-bookings">
        {% for booking in bookings %}
            <div class="gh-booking-block {{ booking.status }}" 
                 style="left: {{ booking.start_offset }}%; width: {{ booking.width }}%;"
                 title="{% if booking.is_live %}ğŸ“¡ ç›´æ’­ä¸­{% else %}{{ booking.user.profile.real_name }} - {{ booking.purpose }}{% endif %}">
                {% if booking.width > 15 %}
                    {% if booking.is_live %}ğŸ“¡{% else %}{{ booking.user.profile.real_name|truncatewords:1 }}{% endif %}
                {% endif %}
            </div>
        {% endfor %}
    </div>
</div>

<!-- Three Sections in responsive grid -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-bottom: 24px;">
    
    <!-- Programs Section -->
    <div class="gh-card">
        <h3 class="gh-card-header">ï¿½ï¿½ èŠ‚ç›®å®‰æ’</h3>
        
        <form method="post" action="{% url 'studio:add_program' date|date:'Y-m-d' %}" style="margin-bottom: 16px;">
            {% csrf_token %}
            <div style="margin-bottom: 8px;">
                <input type="text" name="name" placeholder="èŠ‚ç›®åç§°" required 
                       style="width: 100%; padding: 8px; border: 1px solid var(--gh-border-default); border-radius: 6px;">
            </div>
            <div style="margin-bottom: 8px;">
                <input type="text" name="time_slot" placeholder="æ—¶é—´æ®µ (ä¾‹: 16:00-18:00)" required 
                       style="width: 100%; padding: 8px; border: 1px solid var(--gh-border-default); border-radius: 6px;">
            </div>
            <button type="submit" class="gh-btn gh-btn-primary" style="width: 100%;">æ·»åŠ èŠ‚ç›®</button>
        </form>
        
        <div style="border-top: 1px solid var(--gh-border-muted); padding-top: 12px;">
            {% if programs %}
                {% for program in programs %}
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--gh-border-muted);">
                    <div>
                        <div style="font-weight: 500;">{{ program.name }}</div>
                        <div style="font-size: 12px; color: var(--gh-fg-muted);">{{ program.time_slot }}</div>
                    </div>
                    <form method="post" action="{% url 'studio:delete_program' program.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="gh-btn" onclick="return confirm('ç¡®å®šåˆ é™¤è¯¥èŠ‚ç›®å—ï¼Ÿ')">ğŸ—‘ï¸</button>
                    </form>
                </div>
                {% endfor %}
            {% else %}
                <div class="gh-empty">
                    <p class="gh-empty-text">æš‚æ— èŠ‚ç›®</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Songs Section -->
    <div class="gh-card">
        <h3 class="gh-card-header">ğŸµ æ­Œæ›²åˆ—è¡¨</h3>
        
        <form method="post" action="{% url 'studio:add_song' date|date:'Y-m-d' %}" style="margin-bottom: 16px;">
            {% csrf_token %}
            <div style="margin-bottom: 8px;">
                <input type="text" name="title" placeholder="æ­Œæ›²å" required 
                       style="width: 100%; padding: 8px; border: 1px solid var(--gh-border-default); border-radius: 6px;">
            </div>
            <div style="margin-bottom: 8px;">
                <input type="text" name="artist" placeholder="æ­Œæ‰‹ (å¯é€‰)" 
                       style="width: 100%; padding: 8px; border: 1px solid var(--gh-border-default); border-radius: 6px;">
            </div>
            <button type="submit" class="gh-btn gh-btn-primary" style="width: 100%;">æ·»åŠ æ­Œæ›²</button>
        </form>
        
        <!-- Upload Song with Audio -->
        <div style="padding: 12px; background: var(--gh-canvas-subtle); border-radius: 6px; margin-bottom: 16px;">
            <h4 style="font-size: 14px; font-weight: 600; margin: 0 0 8px 0;">ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</h4>
            <form id="uploadSongForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div style="margin-bottom: 8px;">
                    <input type="text" id="uploadTitle" placeholder="æ­Œæ›²å" required 
                           style="width: 100%; padding: 6px; border: 1px solid var(--gh-border-default); border-radius: 6px; font-size: 13px;">
                </div>
                <div style="margin-bottom: 8px;">
                    <input type="text" id="uploadArtist" placeholder="æ­Œæ‰‹ (å¯é€‰)" 
                           style="width: 100%; padding: 6px; border: 1px solid var(--gh-border-default); border-radius: 6px; font-size: 13px;">
                </div>
                <div style="margin-bottom: 8px;">
                    <input type="file" id="uploadAudioFile" accept="audio/*" required 
                           style="width: 100%; padding: 6px; border: 1px solid var(--gh-border-default); border-radius: 6px; font-size: 13px;">
                </div>
                <button type="submit" class="gh-btn gh-btn-primary" style="width: 100%; font-size: 13px;">ä¸Šä¼ æ­Œæ›²</button>
            </form>
        </div>
        
        <div style="border-top: 1px solid var(--gh-border-muted); padding-top: 12px; max-height: 300px; overflow-y: auto;">
            {% if songs %}
                {% for song in songs %}
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--gh-border-muted);">
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 500;">{{ song.title }}</div>
                        {% if song.artist %}
                        <div style="font-size: 12px; color: var(--gh-fg-muted);">{{ song.artist }}</div>
                        {% endif %}
                        {% if song.audio_file %}
                        <div style="font-size: 11px; color: var(--gh-accent-fg);">ğŸµ å·²ä¸Šä¼ éŸ³é¢‘</div>
                        {% endif %}
                    </div>
                    <form method="post" action="{% url 'studio:delete_song' song.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="gh-btn" onclick="return confirm('ç¡®å®šåˆ é™¤è¯¥æ­Œæ›²å—ï¼Ÿ')">ğŸ—‘ï¸</button>
                    </form>
                </div>
                {% endfor %}
            {% else %}
                <div class="gh-empty">
                    <p class="gh-empty-text">æš‚æ— æ­Œæ›²</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Bookings Section -->
    <div class="gh-card">
        <h3 class="gh-card-header">ğŸ™ï¸ å½•éŸ³å®¤é¢„çº¦</h3>
        
        <div style="margin-bottom: 16px;">
            <a href="{% url 'booking:create' %}?date={{ date|date:'Y-m-d' }}" class="gh-btn gh-btn-primary" style="width: 100%; text-align: center; display: inline-block;">åˆ›å»ºé¢„çº¦</a>
        </div>
        
        <div style="border-top: 1px solid var(--gh-border-muted); padding-top: 12px;">
            {% if bookings %}
                {% for booking in bookings %}
                    {% if not booking.is_live %}
                    <div style="padding: 8px 0; border-bottom: 1px solid var(--gh-border-muted);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-family: ui-monospace; font-size: 13px; font-weight: 600;">
                                {{ booking.start_time|time:"H:i" }}-{{ booking.end_time|time:"H:i" }}
                            </span>
                            <span class="gh-booking-status {{ booking.status }}">
                                {% if booking.status == 'pending' %}å¾…ç¡®è®¤
                                {% elif booking.status == 'confirmed' %}å·²ç¡®è®¤
                                {% elif booking.status == 'completed' %}å·²å®Œæˆ
                                {% endif %}
                            </span>
                        </div>
                        <div style="font-weight: 500; font-size: 14px;">{{ booking.user.profile.real_name }}</div>
                        <div style="font-size: 12px; color: var(--gh-fg-muted);">{{ booking.purpose }}</div>
                    </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <div class="gh-empty">
                    <p class="gh-empty-text">æš‚æ— é¢„çº¦</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Handle song upload with AJAX
document.getElementById('uploadSongForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('title', document.getElementById('uploadTitle').value);
    formData.append('artist', document.getElementById('uploadArtist').value);
    formData.append('audio_file', document.getElementById('uploadAudioFile').files[0]);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "studio:upload_song" date|date:"Y-m-d" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('æ­Œæ›²ä¸Šä¼ æˆåŠŸï¼');
            location.reload();
        } else {
            alert('ä¸Šä¼ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(error => {
        alert('ä¸Šä¼ å¤±è´¥: ' + error);
    });
});
</script>

{% endblock %}
